<!DOCTYPE html>
<html>
<head>
	<title> Campus Mapper </title>
</head>
<body>
	<h1> Campus Mapper </h1>

	
	<div id="map-container" style="position: relative; width: 100%; height: 100%; border: 1px solid #ccc;">
		<canvas id="campus-map">
			
		</canvas>
		
		<div id="compass-container">
			<canvas id="compass">
			
			</canvas>
		</div>

		<div id="input-overlay" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
			<form class="prelim-info" data-info="room" id="room-form">
				<label for="room-id">Enter Current Room:</label>
				<input type="text" id="room-curr-id" />
				<input type="submit" id="Submit Current Room" value="Submit" />
				<label for="room-id">Enter Room:</label>
				<input type="text" id="room-dest-id" />
				<input type="submit" id="Submit Destination Room" value="Submit" />
				<button id="permissionButton"> Grant permission if on IOS </button>
			</form>
			
			<div id="massive-button-container"> 
				<button id="continueButton"> Continue </button>
			</div>
			
			<label for="manualMode">Enable Manual* Mode</label>
			<input type="checkbox" id="manualModeCheckbox" />
			<p id="explanation-manual-mode"> *Manual Mode enables the user to manually press the continue button when they believe they have reached the described location. </p>
			
			
		</div>
		
		<div id="fading">
			
			<h1 id="fadingText"> Welcome to Campus Mapper! To begin, walk in to one of the main entrances, and your current destination will be autofilled. Then, enter your destination location, and the web app will provide you with directions.	 </h1>

		</div>
			
		

	</div>
	
	
	
	
	
	<div id="dev-info" style="position: absolute; top: 0px; left: 0px; background: white; padding 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
		<form class="building-info" id="building-form">
			<label id="building-prefix"> Building: Outside </label>
		</form>
		
		<form class="compass-info" id="compass-form">
			<label id="compass-value"> Compass: 0 </label>
		</form>
	</div>	
	
	
	
	
	
	<style>
		html, body {
			margin: 0;
			padding: 0;
			height: 100%;
			display: flex;
			flex-direction: column;
			background-color: green;
		}
		
		#massive-button-container{
			display: flex;
			flex: 1;
			height: 175px;
			width: 175px;
		}
		
		#explanation-manual-mode{
			font-family: verdana
		}
		
		#continueButton {
			width: 100%;
			height: 100%;
			background-color: #3BB143;
			color: white;
			padding: 10px 20px;
			font-size: 16px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			transition: 0.3s;
			align-self: center;
		}
		
		#continueButton:hover {
			background-color: #0B6623;
		}
		
		#permissionButton {
			height: 25px;
		}
		
		#fading {
			position: absolute;	
			transform: translate(50%, 0%);
			width: 50%;
			background: rgba(128, 128, 128, 0.85);
		}
		
		h1 {
			text-align: center;
			font-family: verdana;
			font-size: 28px;
			color: white;
			margin-bottom: 25px;
		}
		
		
		
		
		
		
		#dev-info {
			display: flex;
			flex-direction: column;
			flex: 1;
			background-color: white;
		}
		
		#fadingText {
		  opacity: 1;
		  color: white;
		  font-size: 20px;
		  transition: opacity 0.75s ease-in-out; 
		}
		
		#map-container {
			display: flex;
			flex: 1;
			background-color: grey;
			border-radius: 10px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.1);
			padding: 0px;
			margin-top: 0px;
			width: 1708px;
			overflow: visible;
			position: relative;
		}
		
		
		#input-overlay {
			width: 180px
		}
		
		#compass-container {
			background: white;
			position: absolute;
			top: 0%;
			left: 90%;
		}
	
		#compass {
			width: 100px; 
			height: 100px; 
			border: 1px solid black;
			background-color: rgba(128, 128, 128, 0.85);
		}
		
		
		
		
		label {
			font-family: verdana;
			font-weight: bold;
			color: #555;
			width: 250px;
		}
		
		
		input[type="text"] {
			padding: 8px;
			border-radius: 5px;
			font-size: 16px;
			flex-grow: 1;
			border: 1px solid #ccc;
			width: 50%;
			box-sizing: border-box;
		}
		
		input[type="text"]:focus {
			background-color: lightgreen;
		}
		
		input[type="submit"] {
			background-color: #3BB143;
			color: white;
			padding: 10px 20px;
			font-size: 16px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			transition: 0.3s;
			align-self: center;
		}
		input[type="submit"]:hover {
			background-color: #0B6623;
		}
		
		
		form {
			display: flex;
			flex-direction: column;
			gap: 15px;
			width: 100%;
		}



		canvas {
			display: flex; 
			position: sticky; 
			top: 0; 
			left: 280px;
		}
		
		
		@media (max-width: 800px) {
		  .flex-container {
			flex-direction: column;
		  }
		}

		
		
	</style>
	
	<script>
		const canvas = document.getElementById("campus-map");
		const ctx = canvas.getContext("2d");

		const aspectRatio = 1708 / 712; 

		
		

		
		/*if (canvasHeight > window.innerHeight * 0.85) {
			canvasHeight = window.innerHeight * 0.85;
			canvasWidth = (canvasHeight) * aspectRatio;
		}*/	

		
		
		let canvasWidth = 1708;
		let canvasHeight = canvasWidth / aspectRatio;
			
		canvas.width = 1708;
		canvas.height = 712;
		
		const img = new Image();
		img.src = "campuspichighres.png";
		


		
		
		const compassCanvas = document.getElementById("compass");
		const ctxCompass = compassCanvas.getContext("2d");
		
		const imgCompass = new Image();
		imgCompass.src = "compass.png";
		
		compassCanvas.width = 100;
		compassCanvas.height = 100;
		
		
		
		
		const form = document.getElementById("room-form");
		
		



		//prefix: "UR", prefix: "BU", prefix: "LB", prefix: "LL", prefix: "MU", prefix: "SC", prefix: "BH", prefix: "SR", prefix: "SI", prefix "FH prefix: "WH"
		var buildings = [];

		buildings[0] = {prefix: "UR", lowerBound: (535 / 712) * canvas.height, upperBound: canvas.height, leftBound: (100 / 1708) * canvas.width, rightBound: (225 / 1708) * canvas.width};
		
		buildings[1] = {prefix : "BU", lowerBound: (350 / 712) * canvas.height, upperBound: (530 / 712) * canvas.height, leftBound: (115 / 1708) * canvas.width, rightBound: (300 / 1708) * canvas.width};
		
		buildings[2] = {prefix: "LL", lowerBound: (245 / 712) * canvas.height, upperBound: (452 / 712) * canvas.height, leftBound: (327 / 1708) * canvas.width, rightBound: (485 / 1708) * canvas.width};
		
		buildings[3] = {prefix: "LB", lowerBound: (453 / 712) * canvas.height, upperBound: (648 / 712) * canvas.height, leftBound: (367 / 1708) * canvas.width, rightBound: (575 / 1708) * canvas.width};
		
		buildings[4] = {prefix: "MU", lowerBound: (355 / 712) * canvas.height, upperBound: (516 / 712) * canvas.height, leftBound: (650 / 1708) * canvas.width, rightBound: (915 / 1708) * canvas.width};
		
		buildings[5] = {prefix: "SC", lowerBound: (360 / 712) * canvas.height, upperBound: (558 / 712) * canvas.height, leftBound: (990 / 1708) * canvas.width, rightBound: (1173 / 1708) * canvas.width};
		
		buildings[6] = {prefix: "BH", lowerBound: (40 / 712) * canvas.height, upperBound: (494 / 712) * canvas.height, leftBound: (1187 / 1708) * canvas.width, rightBound: (1360 / 1708) * canvas.width};
		
		buildings[7] = {prefix: "SR", lowerBound: (257 / 712) * canvas.height, upperBound: (480 / 712) * canvas.height, leftBound: (1361 / 1708) * canvas.width, rightBound: (1516 / 1708) * canvas.width};
		
		buildings[8] = {prefix: "SI", lowerBound: (288 / 712) * canvas.height, upperBound: (480 / 712) * canvas.height, leftBound: (1517 / 1708) * canvas.width, rightBound: (1674 / 1708) * canvas.width};
		
		buildings[9] = {prefix: "FH", lowerBound: (110 / 712) * canvas.height, upperBound: (290 / 712) * canvas.height, leftBound: (1546 / 1708) * canvas.width, rightBound: (1669 / 1708) * canvas.width};
		
		buildings[10] = {prefix: "WH", lowerBound: (14 / 712) * canvas.height, upperBound: (111 / 712) * canvas.height, leftBound: (1367 / 1708) * canvas.width, rightBound: (1626 / 1708) * canvas.width};
		
		
		const ZONES = {
			
			"SC Entrance" : 
			{
				name: "Student Center Entrance",
				description: "You are at the Student Center entrance",
				floor: 1,
				building: "SC"
			},
			
			"SC Stairs Left #1" : 
			{
				name: "Facing left towards the stairs",
				description: "You are at the top of the Student Center stairs",
				floor: 2,
				building: "SC",
			},
			
			"SC Stairs Left #2" :
			{
	
			},
			
			
			"SC Stairs Left #3" :
			{
	
			},
			
			"Viking Marketplace": 
			{
				name: "The Viking Marketplace (cafeteria)",
				description: "You are at the Viking Marketplace",
				floor: 2,
				building: "SC"
			}
		};
		
		const PATHS = [
			{
				from: "SC Entrance",
				to: "SC Stairs Left #1",
				instruction: "Continue straight for roughly 125ft, climb a short flight of stairs, and then there will be another flight of stairs on your left after the vending machine",
				expectedHeading: 0
			},
			
			{
				from: "SC Stairs Left #1",
				to: "SC Stairs Left #2",
				instruction: "Continue up the stairs for a few steps until the floor becomes flat and turn left to begin heading up the next segment of stairs",
				expectedHeading: 90
			},
			
			{
				from: "SC Stairs Left #2",
				to: "SC Stairs Left #3",
				instruction: "Once at the top of this next segment of stairs make another left and continue up the final segment",
				expectedHeading: 90
			},
			
			{
				from: "SC Stairs Left #3",
				to: "SC Stairs Top Landing",
				instruction: "Once at the top of this segment make a left and continue for a few steps past the upwards flight of stairs and then make another left",
				expectedHeading: 90
			},
			
			{ 
				from: "SC Stairs Top Landing",
				to: "Viking Marketplace",
				instruction: "Continue to walk forward and you will arrive at the Viking Marketplace!",
				expectedHeading: 90
			}
			
		];
		
		
		
		
		
		var latitude;
		var longitude;
		
		var travelDir;
		
		
		
		
		
		function compassPointer() 
		{
		
			let angle = (compass === undefined) ? 0 : compass;
			ctxCompass.clearRect(0, 0, compassCanvas.width, compassCanvas.height);
			
			ctxCompass.save();
			ctxCompass.translate(compassCanvas.width / 2, compassCanvas.height / 2);
			
			ctxCompass.rotate(angle * Math.PI / 180);
			
			
		
		
			ctxCompass.drawImage(imgCompass, -imgCompass.width / 2, -imgCompass.height / 2);
			
			ctxCompass.restore();
			
		
		}
		
		function headingSnapshot()
		{
			if(compass == null) {
				return;
			} else {
				return compass;
			}
		
				
		}
		
		const mapContainer = document.getElementById("map-container");
	
		
		let watchId = navigator.geolocation.watchPosition(
		  function(position) {
			
			latitude = position.coords.latitude;
			longitude = position.coords.longitude;
			//console.log(`Updated Latitude: ${latitude}, Longitude: ${longitude}`);
		  },
		  function(error) {
			
			//console.error("Error watching position:", error);
		  },
		  {
			enableHighAccuracy: true,
			timeout: 5000,
			maximumAge: 0
		  }
		);
		
		function draw() {
			
		
			//41.502143341689326, -81.67854782348736
			//latitude = 41.502143341689326;
			//longitude = -81.67854782348736;
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			
			
			var xvalue;
			var yvalue;
			var zoom;
			
			
			
			if(inside){
				mapContainer.style.overflow = "hidden";
				zoom = 2; 
				xvalue = mapX - (window.innerWidth * 0.5) / (2 * zoom);
				yvalue = mapY - (window.innerHeight * 0.5) / (2 * zoom);
			} else {
				mapContainer.style.overflow = "visible";
				xvalue = 0;
				yvalue = 0;
				zoom = 1;
			}
			camera = { x: xvalue, y: yvalue, scale: zoom};
			
			


			renderScene(camera);
			
			if(currBuilding === undefined){
				document.getElementById("building-prefix").textContent = "Building: Outside";
			} else {
				document.getElementById("building-prefix").textContent = "Building: " + currBuilding;
			}
			
			
			
			
			compassPointer();
					



			requestAnimationFrame(draw);
		}
		

		
		
		if (typeof DeviceOrientationEvent.requestPermission === 'function') {
		  document.getElementById('permissionButton').addEventListener('click', () => {
			DeviceOrientationEvent.requestPermission().then(permissionState => {
			  if (permissionState === 'granted') {
				window.addEventListener('deviceorientation', handler);
			  }
			});
		  });
		} else {
			window.addEventListener('deviceorientation', handler);
		}
			
					
		var destinationRoomName = " ";
		var currentRoomName = " ";
		
		var userPathNames = [""];
		var userPath = [""];
		
		form.addEventListener("submit", function(event) {
			event.preventDefault();  // prevent page reload
			pathIndex = 1;
			const button = event.submitter;
			if(button.id === "Submit Current Room"){
				currentRoomName = document.getElementById("room-curr-id").value;
			} else if(button.id === "Submit Destination Room"){
				destinationRoomName = document.getElementById("room-dest-id").value;
			}
			
			if(currentRoomName != ' ' && destinationRoomName != ' '){	
				userPathNames = bread(currentRoomName, destinationRoomName, ZONES, PATHS);
				userPath = [""];
				for(let i = 0; i < userPathNames.length; i++){
					for(let j = 0; j < PATHS.length; j++){
						if(PATHS[j].to === userPathNames[i]){
							userPath.push(PATHS[j]);
						}
					}
				}
			}

		});
		
		var lat;
		var longit;
		
		var compass = 0;
		function handler(e) {
			if(e.alpha != null) {
				compass = 360 - e.alpha;
			}
		}
		
		
		
		

		// Top left: 41.50328051569975, -81.67904912462858
		// Bottom left: 41.50146378558553, -81.67868811305225
		// Top Right: 41.5038595529573, -81.67282733226762
		// Bottom Right: 41.5021184731077, -81.67242593073586
		
	
		
		function drawPolygon(x1, y1, x2, y2, x3, y3, x4, y4, inZone){
			ctx.beginPath();
			ctx.moveTo(x1, y1);
			ctx.lineTo(x2, y2);
			ctx.lineTo(x3, y3);
			ctx.lineTo(x4, y4);
			ctx.closePath();
			ctx.fillStyle = (inZone) ? 'rgba(0, 255, 0, 0.25)' : 'rgba(0, 0, 0, 0)';
			ctx.strokeStyle = 'blue';
			ctx.lineWidth = 2;

			ctx.fill();
			ctx.stroke();
		}
			
		
		
		// ZONES (nodes) & PATHS (edges)
		function bread(start, end, ZONES, PATHS){
			let queue = [[start, [start]]]; // Initialize queue to contain starting point and our current path (just the start right now)
			let visited = new Set([start]); // Set our visited locations to a "set" with our current location
			
			while (queue.length > 0) {
				let [currentZone, path] = queue.shift();
				
				
				if(currentZone === end){ // If we reached our destination it is the shortest path 
					return path;
				}
				
				
				var neighbors = [];
				
				
				// For each element in our PATHS array, if that PATH comes from our currentZone we add it to the neighbors (i.e. it is connected)
				for(let i = 0; i < PATHS.length; i++) { 
					if(PATHS[i].from === currentZone){
						neighbors.push(PATHS[i]);
					}
				}
				
				for(let i = 0; i < neighbors.length; i++){
					let nextZone = neighbors[i].to;
					if(!visited.has(nextZone)){
						visited.add(nextZone);
						let newPath = [...path, nextZone];
						queue.push([nextZone, newPath]);
					}
				}
			}
		}
					
					
			
		
			
			
		
		
		var activatedZone;	
		var inZone;
		var prevInside = 0;
		var inside = 0;
		var currBuilding;
		
		
		var mapX;
		var mapY;
		
		
		var snapshot = 0;
		
		function inRange(value1, value2, tolerance = 20) {
			let diff = Math.abs(value1 - value2) % 360;   
			if (diff > 180){
				diff = 360 - diff;     
			}
			return diff <= tolerance;
		}
	
		
		var lastSampleTime = 0;
		var compassAvg = [];
		
		
		
		// Average our compass readings over 1.5s to get smoothed values
		function compassAverager()
		{
			if(performance.now() - lastSampleTime >= 150){
				lastSampleTime = performance.now();
				
				compassAvg.push(headingSnapshot());
				if(compassAvg.length > 10){
					compassAvg.shift();
				} 
				let sumX = 0, sumY = 0;
				for(let deg of compassAvg){
					let rad = deg * Math.PI / 180;
					sumX += Math.cos(rad);
					sumY += Math.sin(rad);
				}
				let avgRad = Math.atan2(sumY, sumX);
				let avgDeg = (360 - avgRad * 180 / Math.PI + 360) % 360; // handle edge cases
				return avgDeg;
				
			}
		}
				
				
		const fadingText = document.getElementById("fadingText");

		let fadeInProgress = false;

		function updateInstruction(newText) {
		  if (fadeInProgress) return; 

		  fadeInProgress = true;
		  fadingText.style.opacity = 0;

		  setTimeout(() => {
			fadingText.textContent = newText;
			fadingText.style.opacity = 1;

			setTimeout(() => fadeInProgress = false, 750);
		  }, 400); 
		}
		
		


		var pathIndex = 0;
		var manualMode; 
		
		var lastInstruction = null;
		function handleZones() {	
			ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
			
			
			mapX = latLonConvert(latitude, longitude).x;
			mapY = latLonConvert(latitude, longitude).y;
			//mapX = latLonConvert(41.502202824739626, -81.67538178021711).x;
			//mapY = latLonConvert(41.502202824739626, -81.67538178021711).y;
		
			for(let i = 0; i < buildings.length; i++){
				inZone = 0;
				if((mapX < buildings[i].rightBound & mapX > buildings[i].leftBound) & 
				   (mapY < buildings[i].upperBound & mapY > buildings[i].lowerBound)){
					inZone = 1;
					inside = 1;
					currBuilding = buildings[i].prefix;
				}
				drawPolygon(buildings[i].leftBound, buildings[i].lowerBound, 
							buildings[i].rightBound, buildings[i].lowerBound,
							buildings[i].rightBound, buildings[i].upperBound,
							buildings[i].leftBound, buildings[i].upperBound, inZone);
				
			}
			
			
			
			
			var avgSnapshot;
			avgSnapshot = compassAverager();
			
			if (!(avgSnapshot === undefined)) {
				document.getElementById("compass-value").textContent = "Compass: " + Math.round(avgSnapshot);
			}
			
			
			if(inside != prevInside){
				document.getElementById("room-curr-id").value = currBuilding + " Entrance";
				currentRoomName = currBuilding + " Entrance";
				prevInside = inside;
				
				// Capture current heading (should be straight) and intialize pathIndex to zero
				snapshot = headingSnapshot();
				pathIndex = 1;
			}
			

			
			
			manualMode = document.getElementById("manualModeCheckbox").checked;
			
			
			if(userPath.length > 1){
				if(inside){
					if(!manualMode){
						if(!(avgSnapshot === undefined)){
							if(pathIndex < userPath.length){
								if(inRange((avgSnapshot - snapshot), userPath[pathIndex].expectedHeading)){
									if(pathIndex < userPath.length){
										const utterance = new SpeechSynthesisUtterance(userPath[pathIndex].instruction);
										updateInstruction(userPath[pathIndex].instruction);
										window.speechSynthesis.speak(utterance);
									} 
									snapshot = headingSnapshot();
									pathIndex += 1;
								}
							} else {
								updateInstruction(userPath[pathIndex - 1].instruction);
							}
						}
					}else {
						if(pathIndex < userPath.length && userPath[pathIndex].instruction != lastInstruction){
							updateInstruction(userPath[pathIndex].instruction);
							lastInstruction = userPath[pathIndex].instruction;
						} else if(pathIndex >= userPath.length){
							if(lastInstruction != "You have reached your destination!"){
								updateInstruction("You have reached your destination!");
								lastInstruction = "You have reached your destination!";
							}
						}	
					}
				} 
			}
			// Draw user location as a red dot
			ctx.beginPath();
			ctx.arc(mapX, mapY, 5, 0, 2 * Math.PI);
			ctx.fillStyle = "rgba(255, 0, 0, 1.0)";
			ctx.fill();
			ctx.strokeStyle = "black";
			ctx.stroke();
			
		
			
			
		}
		
		
		
		const button = document.getElementById("continueButton");	
		button.addEventListener("click", function(event) {
			event.preventDefault();  // prevent page reload
			
			if((!(userPath === undefined)) && manualMode && inside){
				

				pathIndex += 1;
			}
				
		});
		
		
		
		
		function renderScene(camera) {
			ctx.setTransform(camera.scale, 0, 0, camera.scale, -camera.x*camera.scale, -camera.y*camera.scale);
			handleZones();
		}
		
		// Top left of image: 41.50385334040492, -81.6804914654469
		// Bottom right of image: 41.50134173780734, -81.67246588380492
		
		function latLonConvert(lat, lon){
			let xscale = (81.6804914654469 + lon) / (81.6804914654469 - 81.67246588380492);
			let yscale = (41.50385334040492 - lat) / (41.50385334040492 - 41.50134173780734);
			
			return {
				x: xscale * canvas.width,
				y: yscale * canvas.height
			}
		}	
		
		
		img.onload = () => {
			draw();
		};
		
		
		

		
	</script>
</body>

</html>

